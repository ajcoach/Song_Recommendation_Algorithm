# -*- coding: utf-8 -*-
"""
Created on Wed Oct 27 18:50:24 2021

@author: ajc364
"""

from pyspark.ml.feature import StringIndexer
from pyspark.ml.classification import RandomForestClassifier


### Question 4 b ###

audio_features_genre = audio_features.join(genre, on = 'track_id', how = 'inner')
audio_features_genre.show()

""" Output
+------------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+-------------+
|          track_id|feature_0000|feature_0001|feature_0002|feature_0003|feature_0004|feature_0005|feature_0006|feature_0007|feature_0008|feature_0009|   genre_type|
+------------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+-------------+
|TRAAABD128F429CF47|      0.1308|       9.587|       459.9|     27280.0|   4303000.0|      0.2474|       26.02|      1067.0|     67790.0|   8281000.0|     Pop_Rock|
|TRAABPK128F424CFDB|      0.1208|       6.738|       215.1|     11890.0|   2278000.0|      0.4882|       41.76|      2164.0|    220400.0|      3.79E7|     Pop_Rock|
|TRAACER128F4290F96|      0.2838|       8.995|       429.5|     31990.0|   5272000.0|      0.5388|       28.29|      1656.0|    185100.0|     3.164E7|     Pop_Rock|
|TRAADYB128F92D7E73|      0.1346|       7.321|       499.6|     38460.0|   5877000.0|      0.2839|       15.75|       929.6|    116500.0|     2.058E7|         Jazz|
|TRAAGHM128EF35CF8E|      0.1563|       9.959|       502.8|     26190.0|   3660000.0|      0.3835|       28.24|      1864.0|    180800.0|     2.892E7|   Electronic|
|TRAAGRV128F93526C0|      0.1076|       7.401|       389.7|     19350.0|   2739000.0|      0.4221|       30.99|      1861.0|    191700.0|     3.166E7|     Pop_Rock|
|TRAAGTO128F1497E3C|      0.1069|       8.987|       562.6|     43100.0|   7057000.0|      0.1007|        22.9|      1346.0|    157700.0|     2.738E7|     Pop_Rock|
|TRAAHAU128F9313A3D|     0.08485|       9.031|       445.9|     23750.0|   3274000.0|      0.2583|       35.59|      2015.0|    198400.0|     3.336E7|     Pop_Rock|
|TRAAHEG128E07861C3|      0.1699|       17.22|       741.3|     52440.0|   8275000.0|      0.2812|       28.83|      1671.0|    160800.0|     2.695E7|          Rap|
|TRAAHZP12903CA25F4|      0.1654|       12.31|       565.1|     33100.0|   5273000.0|      0.1861|       38.38|      1962.0|    196600.0|     3.355E7|          Rap|
|TRAAICW128F1496C68|      0.1104|       7.123|       398.2|     19540.0|   3240000.0|      0.2871|       28.53|      1807.0|    189400.0|     3.156E7|International|
|TRAAJJW12903CBDDCB|      0.2267|       14.88|       592.7|     37980.0|   4569000.0|      0.4219|       36.17|      2111.0|    179400.0|     2.952E7|International|
|TRAAJKJ128F92FB44F|     0.03861|        6.87|       407.8|     41310.0|   7299000.0|      0.0466|       15.79|       955.1|    121700.0|     2.124E7|         Folk|
|TRAAKLX128F934CEE4|      0.1647|       16.77|       850.0|     64420.0|     1.011E7|      0.2823|       26.52|      1600.0|    152000.0|     2.587E7|   Electronic|
|TRAAKWR128F931B29F|     0.04881|       9.331|       564.0|     34410.0|   4920000.0|     0.08647|        18.1|       880.5|     57700.0|   6429000.0|     Pop_Rock|
|TRAALQN128E07931A4|      0.1989|       12.83|       578.7|     30690.0|   4921000.0|      0.5452|       33.37|      2019.0|    188700.0|      3.14E7|   Electronic|
|TRAAMFF12903CE8107|      0.1385|       9.699|       581.6|     31590.0|   4569000.0|      0.3706|       23.63|      1554.0|    163800.0|      2.72E7|     Pop_Rock|
|TRAAMHG128F92ED7B2|      0.1799|       10.52|       551.4|     29170.0|   4396000.0|      0.4046|       30.78|      1806.0|    183200.0|     3.059E7|International|
|TRAAROH128F42604B0|      0.1192|        16.4|       737.3|     41670.0|   6295000.0|      0.2284|       31.04|      1878.0|    169100.0|     2.829E7|   Electronic|
|TRAARQN128E07894DF|      0.2559|       15.23|       757.1|     61750.0|     1.065E7|      0.5417|       40.96|      2215.0|    189000.0|      3.21E7|     Pop_Rock|
+------------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+-------------+
only showing top 20 rows
"""



""" Removed
audio_features_genre = features_not_mismatched.join(msd_not_mismatched, on = "track_id", how = "inner")
"""

indexer = StringIndexer(inputCol = "genre_type", outputCol = "genre").fit(audio_features_genre)

indexed_audio_features_genre = indexer.transform(audio_features_genre)
indexed_audio_features_genre.show()

""" Output
+------------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+-------------+-----+
|          track_id|feature_0000|feature_0001|feature_0002|feature_0003|feature_0004|feature_0005|feature_0006|feature_0007|feature_0008|feature_0009|   genre_type|genre|
+------------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+-------------+-----+
|TRAAABD128F429CF47|      0.1308|       9.587|       459.9|     27280.0|   4303000.0|      0.2474|       26.02|      1067.0|     67790.0|   8281000.0|     Pop_Rock|  0.0|
|TRAABPK128F424CFDB|      0.1208|       6.738|       215.1|     11890.0|   2278000.0|      0.4882|       41.76|      2164.0|    220400.0|      3.79E7|     Pop_Rock|  0.0|
|TRAACER128F4290F96|      0.2838|       8.995|       429.5|     31990.0|   5272000.0|      0.5388|       28.29|      1656.0|    185100.0|     3.164E7|     Pop_Rock|  0.0|
|TRAADYB128F92D7E73|      0.1346|       7.321|       499.6|     38460.0|   5877000.0|      0.2839|       15.75|       929.6|    116500.0|     2.058E7|         Jazz|  3.0|
|TRAAGHM128EF35CF8E|      0.1563|       9.959|       502.8|     26190.0|   3660000.0|      0.3835|       28.24|      1864.0|    180800.0|     2.892E7|   Electronic|  1.0|
|TRAAGRV128F93526C0|      0.1076|       7.401|       389.7|     19350.0|   2739000.0|      0.4221|       30.99|      1861.0|    191700.0|     3.166E7|     Pop_Rock|  0.0|
|TRAAGTO128F1497E3C|      0.1069|       8.987|       562.6|     43100.0|   7057000.0|      0.1007|        22.9|      1346.0|    157700.0|     2.738E7|     Pop_Rock|  0.0|
|TRAAHAU128F9313A3D|     0.08485|       9.031|       445.9|     23750.0|   3274000.0|      0.2583|       35.59|      2015.0|    198400.0|     3.336E7|     Pop_Rock|  0.0|
|TRAAHEG128E07861C3|      0.1699|       17.22|       741.3|     52440.0|   8275000.0|      0.2812|       28.83|      1671.0|    160800.0|     2.695E7|          Rap|  2.0|
|TRAAHZP12903CA25F4|      0.1654|       12.31|       565.1|     33100.0|   5273000.0|      0.1861|       38.38|      1962.0|    196600.0|     3.355E7|          Rap|  2.0|
|TRAAICW128F1496C68|      0.1104|       7.123|       398.2|     19540.0|   3240000.0|      0.2871|       28.53|      1807.0|    189400.0|     3.156E7|International|  6.0|
|TRAAJJW12903CBDDCB|      0.2267|       14.88|       592.7|     37980.0|   4569000.0|      0.4219|       36.17|      2111.0|    179400.0|     2.952E7|International|  6.0|
|TRAAJKJ128F92FB44F|     0.03861|        6.87|       407.8|     41310.0|   7299000.0|      0.0466|       15.79|       955.1|    121700.0|     2.124E7|         Folk| 12.0|
|TRAAKLX128F934CEE4|      0.1647|       16.77|       850.0|     64420.0|     1.011E7|      0.2823|       26.52|      1600.0|    152000.0|     2.587E7|   Electronic|  1.0|
|TRAAKWR128F931B29F|     0.04881|       9.331|       564.0|     34410.0|   4920000.0|     0.08647|        18.1|       880.5|     57700.0|   6429000.0|     Pop_Rock|  0.0|
|TRAALQN128E07931A4|      0.1989|       12.83|       578.7|     30690.0|   4921000.0|      0.5452|       33.37|      2019.0|    188700.0|      3.14E7|   Electronic|  1.0|
|TRAAMFF12903CE8107|      0.1385|       9.699|       581.6|     31590.0|   4569000.0|      0.3706|       23.63|      1554.0|    163800.0|      2.72E7|     Pop_Rock|  0.0|
|TRAAMHG128F92ED7B2|      0.1799|       10.52|       551.4|     29170.0|   4396000.0|      0.4046|       30.78|      1806.0|    183200.0|     3.059E7|International|  6.0|
|TRAAROH128F42604B0|      0.1192|        16.4|       737.3|     41670.0|   6295000.0|      0.2284|       31.04|      1878.0|    169100.0|     2.829E7|   Electronic|  1.0|
|TRAARQN128E07894DF|      0.2559|       15.23|       757.1|     61750.0|     1.065E7|      0.5417|       40.96|      2215.0|    189000.0|      3.21E7|     Pop_Rock|  0.0|
+------------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+------------+-------------+-----+
only showing top 20 rows
"""



assembler = VectorAssembler(
    inputCols = [col for col in indexed_audio_features_genre.columns if col.startswith("feature_")],
    outputCol = "Features"
)
features = assembler.transform(indexed_audio_features_genre).select(["Features", "genre"])
features.cache()
features.count()

""" Output
420620
"""

show_class_balance(indexed_audio_features_genre, 'indexed_audio_features_genre')

""" Output
indexed_audio_features_genre
420620
    genre   count     ratio
0    13.0    4000  0.009510
1    12.0    5789  0.013763
2     6.0   14194  0.033745
3     1.0   40666  0.096681
4    10.0    6801  0.016169
5    16.0    1535  0.003649
6    19.0     463  0.001101
7     5.0   14314  0.034031
8     7.0   11691  0.027795
9     4.0   17504  0.041615
10   17.0    1012  0.002406
11   20.0     200  0.000475
12    9.0    6931  0.016478
13    8.0    8780  0.020874
14   14.0    2067  0.004914
15    0.0  237649  0.564997
16   18.0     555  0.001319
17    3.0   17775  0.042259
18    2.0   20899  0.049686
19   11.0    6182  0.014697
20   15.0    1613  0.003835
"""

counts = features.groupBy("genre").count().toPandas().set_index("genre")["count"].to_dict()

temp = (
    features
    .withColumn("id", monotonically_increasing_id())
    .withColumn("random", rand())
    .withColumn(
        "row",
        row_number()
        .over(
            Window
            .partitionBy("genre")
            .orderBy("random")
        )
    )
)

training = temp
training.show()

""" Output
+--------------------+-----+------------+--------------------+---+
|            Features|genre|          id|              random|row|
+--------------------+-----+------------+--------------------+---+
|[0.208,13.39,558....|  6.0| 60129566136|1.606144376886664...|  1|
|[0.134,12.15,591....|  6.0| 60129564748|1.103221642299034...|  2|
|[0.2326,14.9,603....|  6.0|128849041298|1.260459297430793...|  3|
|[0.1517,5.904,337...|  6.0| 60129562838|1.425839087400016E-4|  4|
|[0.1411,12.98,534...|  6.0| 17179876417|2.767745989977754...|  5|
|[0.09289,13.42,67...|  6.0| 34359748111|4.714416641339314E-4|  6|
|[0.2529,12.91,633...|  6.0| 34359756488|5.141145733053021E-4|  7|
|[0.1664,9.467,466...|  6.0|       10495|7.352246446014066E-4|  8|
|[0.2015,12.83,625...|  6.0|  8589936636|7.540158101276839E-4|  9|
|[0.1958,9.779,546...|  6.0| 42949692093|8.767348016426313E-4| 10|
|[0.1089,7.982,499...|  6.0| 85899352690| 8.90721018104057E-4| 11|
|[0.1858,13.38,597...|  6.0| 51539618355|9.036010719644105E-4| 12|
|[0.1181,5.358,251...|  6.0|111669175616|0.001025814739833...| 13|
|[0.2175,11.88,511...|  6.0| 51539629662|0.001132837907628...| 14|
|[0.1362,9.41,566....|  6.0| 68719477448|0.001184632357573...| 15|
|[0.1466,9.397,423...|  6.0| 34359763957|0.001241282745349...| 16|
|[0.1984,12.94,565...|  6.0| 51539616552|0.001497418571079212| 17|
|[0.2508,14.34,585...|  6.0| 51539621256|0.001513172427781373| 18|
|[0.0766,8.419,430...|  6.0|103079241080|0.001652913305854...| 19|
|[0.2184,9.713,419...|  6.0|       12535|0.001723150544581...| 20|
+--------------------+-----+------------+--------------------+---+
only showing top 20 rows
"""


for k, v in counts.items():
    training = training.where((col("genre") != k) | (col("row") < v * 0.8))
    
test = temp.join(training, on = "id", how = "left_anti")
test.cache()

training = training.drop("id", "Random", "Row")
test = test.drop("id", "Random", "Row")

show_class_balance(features, "Features:")

""" Output
Features:
420620
    genre   count     ratio
0     6.0   14194  0.033745
1    12.0    5789  0.013763
2    13.0    4000  0.009510
3     1.0   40666  0.096681
4    10.0    6801  0.016169
5    19.0     463  0.001101
6    16.0    1535  0.003649
7     5.0   14314  0.034031
8     7.0   11691  0.027795
9     4.0   17504  0.041615
10   17.0    1012  0.002406
11   20.0     200  0.000475
12    9.0    6931  0.016478
13    8.0    8780  0.020874
14   14.0    2067  0.004914
15    0.0  237649  0.564997
16   18.0     555  0.001319
17    3.0   17775  0.042259
18    2.0   20899  0.049686
19   11.0    6182  0.014697
20   15.0    1613  0.003835
"""

show_class_balance(training, "Training:")

""" Output
Training:
336483
    genre   count     ratio
0     6.0   11355  0.033746
1    12.0    4631  0.013763
2    13.0    3199  0.009507
3     1.0   32532  0.096682
4    10.0    5440  0.016167
5    16.0    1227  0.003647
6    19.0     370  0.001100
7     5.0   11451  0.034031
8     7.0    9352  0.027793
9     4.0   14003  0.041616
10   17.0     809  0.002404
11   20.0     159  0.000473
12    8.0    7023  0.020872
13    9.0    5544  0.016476
14   14.0    1653  0.004913
15    0.0  190119  0.565018
16   18.0     443  0.001317
17    3.0   14219  0.042258
18    2.0   16719  0.049688
19   11.0    4945  0.014696
20   15.0    1290  0.003834
"""


show_class_balance(test, "Test:")

"""  Output
Test:
84137
    genre  count     ratio
0     6.0   2839  0.033743
1    12.0   1158  0.013763
2    13.0    801  0.009520
3     1.0   8134  0.096676
4    10.0   1361  0.016176
5    16.0    308  0.003661
6    19.0     93  0.001105
7     5.0   2863  0.034028
8     7.0   2339  0.027800
9     4.0   3501  0.041611
10   17.0    203  0.002413
11   20.0     41  0.000487
12    8.0   1757  0.020883
13    9.0   1387  0.016485
14   14.0    414  0.004921
15    0.0  47530  0.564912
16   18.0    112  0.001331
17    3.0   3556  0.042264
18    2.0   4180  0.049681
19   11.0   1237  0.014702
20   15.0    323  0.003839
"""

rf = RandomForestClassifier(featuresCol = 'Features', labelCol = 'genre')
multiclass_rf_model = rf.fit(training)
multiclass_rf_predictions = multiclass_rf_model.transform(test)
multiclass_rf_predictions.cache()

show_binary_metrics(multiclass_rf_predictions, "multiclass_rf_predictions", labelCol = 'genre')



